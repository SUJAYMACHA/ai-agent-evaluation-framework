# API Documentation

## Overview

The AI Agent Evaluation Framework provides a REST API for ingesting evaluation data.

## Base URL

- **Development**: `http://localhost:3000/api`
- **Production**: `https://your-domain.com/api`

## Authentication

All API endpoints require authentication using Supabase Auth. Include the session cookie in your requests.

### Getting an Auth Token

**Sign Up:**
```bash
POST /auth/v1/signup
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "your-password"
}
```

**Sign In:**
```bash
POST /auth/v1/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "your-password"
}
```

The response will include an `access_token` that you should include in subsequent requests.

## Endpoints

### POST /api/evals/ingest

Ingest a new evaluation record.

#### Request

**Headers:**
```
Content-Type: application/json
Cookie: sb-[project-id]-auth-token=[token]
```

Or alternatively:
```
Content-Type: application/json
Authorization: Bearer [access_token]
```

**Body:**
```json
{
  "interaction_id": "string (required)",
  "prompt": "string (required)",
  "response": "string (required)",
  "score": 0.95,
  "latency_ms": 1234,
  "flags": ["optional", "array", "of", "strings"],
  "pii_tokens_redacted": 0
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `interaction_id` | string | Yes | Unique identifier for the interaction |
| `prompt` | string | Yes | The input prompt sent to the AI agent |
| `response` | string | Yes | The response generated by the AI agent |
| `score` | number | Yes | Quality score between 0.0 and 1.0 |
| `latency_ms` | integer | Yes | Response time in milliseconds |
| `flags` | array | No | Array of flag strings (e.g., ["failed", "pii_detected"]) |
| `pii_tokens_redacted` | integer | No | Number of PII tokens redacted (default: 0) |

#### Response

**Success (201 Created):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "user_id": "uuid",
    "interaction_id": "string",
    "prompt": "string",
    "response": "string",
    "score": 0.95,
    "latency_ms": 1234,
    "flags": ["array"],
    "pii_tokens_redacted": 0,
    "created_at": "2024-01-01T00:00:00.000Z"
  }
}
```

**Error (400 Bad Request):**
```json
{
  "error": "Missing required fields: interaction_id, prompt, response, score, latency_ms"
}
```

**Error (401 Unauthorized):**
```json
{
  "error": "Unauthorized"
}
```

**Error (500 Internal Server Error):**
```json
{
  "error": "Error message describing what went wrong"
}
```

## Example Requests

### cURL (PowerShell)

```powershell
# First, login and get a token
$loginResponse = Invoke-RestMethod -Uri "https://your-project.supabase.co/auth/v1/token?grant_type=password" `
  -Method Post `
  -Headers @{
    "apikey" = "your-anon-key"
    "Content-Type" = "application/json"
  } `
  -Body (@{
    email = "user@example.com"
    password = "your-password"
  } | ConvertTo-Json)

$token = $loginResponse.access_token

# Ingest an evaluation
Invoke-RestMethod -Uri "http://localhost:3000/api/evals/ingest" `
  -Method Post `
  -Headers @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
  } `
  -Body (@{
    interaction_id = "test-interaction-123"
    prompt = "What is the capital of France?"
    response = "The capital of France is Paris."
    score = 0.98
    latency_ms = 250
    flags = @()
    pii_tokens_redacted = 0
  } | ConvertTo-Json)
```

### JavaScript/TypeScript

```typescript
// Using fetch API
async function ingestEvaluation(token: string, data: any) {
  const response = await fetch('http://localhost:3000/api/evals/ingest', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error);
  }

  return response.json();
}

// Example usage
const evaluationData = {
  interaction_id: 'test-interaction-123',
  prompt: 'What is the capital of France?',
  response: 'The capital of France is Paris.',
  score: 0.98,
  latency_ms: 250,
  flags: [],
  pii_tokens_redacted: 0,
};

try {
  const result = await ingestEvaluation(accessToken, evaluationData);
  console.log('Success:', result);
} catch (error) {
  console.error('Error:', error);
}
```

### Python

```python
import requests
import json

# Login first
login_response = requests.post(
    'https://your-project.supabase.co/auth/v1/token?grant_type=password',
    headers={
        'apikey': 'your-anon-key',
        'Content-Type': 'application/json'
    },
    json={
        'email': 'user@example.com',
        'password': 'your-password'
    }
)

token = login_response.json()['access_token']

# Ingest evaluation
evaluation_data = {
    'interaction_id': 'test-interaction-123',
    'prompt': 'What is the capital of France?',
    'response': 'The capital of France is Paris.',
    'score': 0.98,
    'latency_ms': 250,
    'flags': [],
    'pii_tokens_redacted': 0
}

response = requests.post(
    'http://localhost:3000/api/evals/ingest',
    headers={
        'Authorization': f'Bearer {token}',
        'Content-Type': 'application/json'
    },
    json=evaluation_data
)

if response.status_code == 201:
    print('Success:', response.json())
else:
    print('Error:', response.json())
```

### Node.js (with Supabase SDK)

```javascript
const { createClient } = require('@supabase/supabase-js');

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);

async function ingestEvaluation(evaluationData) {
  // Authenticate first
  const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
    email: 'user@example.com',
    password: 'your-password'
  });

  if (authError) throw authError;

  // Get session token
  const session = await supabase.auth.getSession();
  const token = session.data.session.access_token;

  // Ingest evaluation
  const response = await fetch('http://localhost:3000/api/evals/ingest', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(evaluationData),
  });

  return response.json();
}

// Example usage
const data = {
  interaction_id: 'test-123',
  prompt: 'What is AI?',
  response: 'AI is artificial intelligence...',
  score: 0.95,
  latency_ms: 300,
  flags: [],
  pii_tokens_redacted: 0
};

ingestEvaluation(data)
  .then(result => console.log('Success:', result))
  .catch(error => console.error('Error:', error));
```

## Rate Limiting

Currently, there are no hard rate limits enforced by the application. However, Supabase may enforce limits based on your plan:

- **Free Tier**: Up to 500,000 API requests per month
- **Pro Tier**: Unlimited API requests

Consider implementing your own rate limiting if needed.

## Batch Ingestion

For ingesting multiple evaluations at once, you can call the endpoint multiple times or directly insert into Supabase:

```javascript
// Direct Supabase insertion (server-side only)
const { data, error } = await supabase
  .from('evaluations')
  .insert([
    { /* evaluation 1 */ },
    { /* evaluation 2 */ },
    // ... more evaluations
  ]);
```

## Error Handling

All errors follow a consistent format:

```json
{
  "error": "Human-readable error message"
}
```

### Common Error Codes

| Code | Meaning | Common Causes |
|------|---------|---------------|
| 400 | Bad Request | Missing required fields, invalid data format |
| 401 | Unauthorized | Missing or invalid authentication token |
| 403 | Forbidden | RLS policy violation, insufficient permissions |
| 500 | Internal Server Error | Database error, unexpected server issue |

## Best Practices

1. **Batch Processing**: For high-volume scenarios, batch your requests to reduce overhead
2. **Error Handling**: Always implement proper error handling and retries
3. **Token Management**: Cache and reuse auth tokens instead of logging in for each request
4. **Validation**: Validate data on the client side before sending to reduce errors
5. **Monitoring**: Log API responses for debugging and monitoring

## Future Endpoints (Roadmap)

- `GET /api/evals` - List evaluations with filtering and pagination
- `GET /api/evals/:id` - Get a specific evaluation
- `PUT /api/evals/:id` - Update an evaluation
- `DELETE /api/evals/:id` - Delete an evaluation
- `GET /api/stats` - Get aggregate statistics
- `POST /api/evals/batch` - Batch ingest multiple evaluations

## Support

For API issues or questions:
- Check the main README.md
- Review Supabase documentation
- Open an issue on GitHub

---

Happy coding! ðŸš€
